{% extends "base.html" %}

{% block title %}Invoice Administration{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-dark"><i class="fas fa-file-invoice-dollar me-2 text-danger"></i>Invoice Administration</h2>
    <p class="text-muted">Review and manage all invoices across your organization.</p>
</div>

<div class="card shadow-sm">
    <div class="table-responsive">
        <table class="table table-custom table-hover align-middle mb-0">
            <thead>
                <tr>
                    <th class="ps-4">ID</th>
                    <th>Unit</th>
                    <th>Property</th>
                    <th>Amount</th>
                    <th>Due Date</th>
                    <th>Status</th>
                    <th>Sender</th>
                    <th class="text-end pe-4">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for invoice in invoices %}
                <tr>
                    <td class="ps-4 text-muted">#{{ invoice.id }}</td>
                    <td class="fw-bold">{{ invoice.unit.unit_number }}</td>
                    <td>{{ invoice.unit.property.name }}</td>
                    <td class="fw-bold">KES {{ invoice.amount }}</td>
                    <td>{{ invoice.due_date }}</td>
                    <td>
                        {% if invoice.is_paid %}
                            <span class="badge bg-success">Paid ({{ invoice.payment_date|date:"M d, Y" }})</span>
                        {% else %}
                            <span class="badge bg-danger">Unpaid</span>
                        {% endif %}
                    </td>
                    <td>{{ invoice.get_sender_role_display }}</td>
                    <td class="text-end pe-4">
                        {% if not invoice.is_paid %}
                            <button class="btn btn-sm btn-success mark-paid-btn" data-invoice-id="{{ invoice.id }}">
                                Mark Paid
                            </button>
                        {% else %}
                            <button class="btn btn-sm btn-secondary" disabled>Managed</button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center py-4 text-muted">No invoices found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="status-message" class="mt-3"></div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    document.querySelectorAll('.mark-paid-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
            const invoiceId = e.target.getAttribute('data-invoice-id');
            const feedbackDiv = document.getElementById('status-message');
            
            feedbackDiv.innerHTML = '<div class="alert alert-info">Processing...</div>';

            const formData = new FormData();
            formData.append('invoice_id', invoiceId);

            try {
                const response = await fetch("{% url 'property:mark_invoice_paid_api' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken },
                    body: formData
                });
                
                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    feedbackDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                    setTimeout(() => window.location.reload(), 1000); // Reload to update table
                } else {
                    feedbackDiv.innerHTML = `<div class="alert alert-danger">${result.message || 'Error marking invoice.'}</div>`;
                }

            } catch (error) {
                feedbackDiv.innerHTML = `<div class="alert alert-danger">Network error.</div>`;
            }
        });
    });
</script>
{% endblock content %}